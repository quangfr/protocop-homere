<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Homere Connect ‚Äî Prototype</title>
  <style>
    :root{
      --accent:#3C71A5;
      --accent-soft:#EDF2FA;
      --bg:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --muted-2:#9ca3af;
      --line:#e5e7eb;
      --chip:#edf2fa;
      --ok:#16a34a;
      --ko:#b91c1c;
      --warn:#b45309;
      --card:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:var(--bg);border-bottom:1px solid var(--line)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
    .topbar .left,.topbar .right{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px;color:var(--accent)}
    .brand .logo{width:32px;height:32px;display:inline-grid;place-items:center;border-radius:10px;background:var(--accent);color:#fff;font-size:18px}
    select,input[type="text"],input[type="number"],textarea{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;color:var(--text);outline:none;box-shadow:none;font-size:14px}
    select{min-width:160px}
    input[type="text"]{min-width:220px}
    button{border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:12px;padding:8px 12px;font-weight:600;cursor:pointer}
    button.ghost{background:#fff;color:var(--accent)}
    button:disabled{opacity:.5;cursor:not-allowed}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:0;height:calc(100vh - 110px)}
    .panel-left{border-right:1px solid var(--line);overflow:auto;background:#fff}
    .panel-right{overflow:auto;background:#fff}
    .list-header{display:flex;align-items:center;gap:8px;padding:12px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#fff;z-index:2}
    .list{padding:8px 8px}
    .row{display:grid;grid-template-columns:44px 1fr auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:14px;padding:8px 10px;margin:8px;background:var(--card);cursor:pointer;transition:box-shadow .2s ease,transform .2s ease}
    .row:hover{box-shadow:0 6px 18px rgba(60,113,165,0.12);transform:translateY(-2px)}
    .avatar{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:var(--chip);font-size:18px;color:var(--accent)}
    .row .title{font-weight:700}
    .row .meta{font-size:12px;color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--accent);border:1px solid rgba(60,113,165,0.25);padding:2px 8px;border-radius:999px;font-size:12px}
    .detail{padding:16px 24px;max-width:1200px;margin:0 auto}
    .detail h2{margin:8px 0 4px 0}
    .section{border:1px solid var(--line);border-radius:16px;padding:16px;margin:14px 0;background:#fff}
    .section h3{margin-top:0}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kv{display:grid;grid-template-columns:180px 1fr;gap:8px;align-items:center;font-size:14px}
    .kv label{color:var(--muted)}
    .badge{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .badge.ok{color:var(--ok);background:#ecfdf5;border-color:#d1fae5}
    .badge.ko{color:var(--ko);background:#fef2f2;border-color:#fecaca}
    .context-pill{background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:2px 12px;font-size:12px;color:#111827}
    .footer{padding:10px 16px;border-top:1px solid var(--line);font-size:12px;color:var(--muted);display:flex;justify-content:space-between}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{color:var(--muted);font-weight:500;background:#f9fafb}
    .table tbody tr:last-child td{border-bottom:none}
    .status-icon{font-size:16px}
    .indicator{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:600}
    .indicator.yes{color:var(--ok)}
    .indicator.no{color:var(--ko)}
    .accordion{border:1px solid var(--line);border-radius:14px;margin:10px 0;background:#fafafa}
    .accordion-toggle{width:100%;background:none;border:none;padding:14px 16px;display:flex;flex-direction:column;align-items:flex-start;gap:6px;font-size:14px;text-align:left;cursor:pointer}
    .accordion-toggle .title-row{display:flex;gap:12px;align-items:center;width:100%;justify-content:space-between}
    .accordion-toggle .title-row .left{display:flex;gap:12px;align-items:center}
    .accordion-toggle .label{font-weight:700}
    .accordion-toggle .meta{font-size:12px;color:var(--muted)}
    .accordion-toggle.open{background:var(--accent-soft);color:var(--accent)}
    .accordion-panel{display:none;border-top:1px solid var(--line);padding:16px;background:#fff;border-radius:0 0 14px 14px}
    .accordion-panel.open{display:block}
    .payroll-lines{width:100%;border-collapse:collapse;font-size:13px}
    .payroll-lines td{padding:8px 12px;border-bottom:1px solid var(--line)}
    .payroll-lines tr:last-child td{border-bottom:none}
    .tone-positive{color:var(--ok)}
    .tone-negative{color:var(--ko)}
    .tone-warning{color:var(--warn)}
    .tone-neutral{color:var(--accent)}
    .tone-summary{font-weight:700;color:var(--accent)}
    .download-icon{font-size:18px}
    @media (max-width:1100px){
      .layout{grid-template-columns:1fr}
      .panel-left{height:auto;border-right:none;border-bottom:1px solid var(--line)}
    }
    @media (max-width:720px){
      .grid-3{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
      .kv{grid-template-columns:1fr}
      .layout{height:auto}
      select,input[type="text"]{width:100%}
      .topbar{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="left">
        <div class="brand"><span class="logo">üîó</span> Homere Connect ‚Äî Prototype</div>
        <div>
          <label for="terrainSelect">üåç Terrain</label>
          <select id="terrainSelect"></select>
        </div>
      </div>
      <div class="right">
        <div>
          <label for="globalSearch">üîç Recherche</label>
          <input id="globalSearch" type="text" placeholder="Nom, fonction, contrat‚Ä¶" />
        </div>
        <div>
          <label for="contractFilter">Type de contrat</label>
          <select id="contractFilter"></select>
        </div>
        <div>
          <label for="categoryFilter">Cat√©gorie socio-prof.</label>
          <select id="categoryFilter"></select>
        </div>
        <div>
          <label for="statusFilter">Statut</label>
          <select id="statusFilter"></select>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <aside class="panel-left">
      <div class="list-header">
        <span id="listTitle" style="font-weight:700">Employ√©s</span>
        <span class="badge" id="listCount">0</span>
        <span class="context-pill" id="contextPill">Mode fiche employ√©</span>
      </div>
      <div id="list" class="list"></div>
    </aside>
    <section class="panel-right">
      <div id="detail" class="detail">
        <h2>Bienvenue üëã</h2>
        <p>S√©lectionnez un employ√© dans la liste de gauche pour afficher sa fiche d√©taill√©e.</p>
      </div>
    </section>
  </main>

  <div class="footer">
    <div>Version d√©monstration ‚Ä¢ Homere Connect</div>
    <div id="stats"></div>
  </div>

  <script>
    const TERRAINS = [
      { code: 'CD_KIN1', name: 'Kinshasa', flag: 'üá®üá©', currency: 'USD' },
      { code: 'CD_LUB1', name: 'Lubumbashi', flag: 'üá®üá©', currency: 'USD' },
      { code: 'CD_GOM1', name: 'Goma', flag: 'üá®üá©', currency: 'USD' },
      { code: 'CD_KIS1', name: 'Kisangani', flag: 'üá®üá©', currency: 'USD' },
      { code: 'CD_MBA1', name: 'Mbandaka', flag: 'üá®üá©', currency: 'USD' }
    ];

    const CONTRACT_TYPES = ['CDD', 'CDI', 'Consultant', 'Prestation', 'Stage'];
    const SOCIO_CATEGORIES = ['EMP', 'AMT', 'CAD'];
    const CIVILITIES = ['Monsieur', 'Madame'];
    const MARITAL_STATUS = ['C√©libataire', 'Mari√©(e)', 'Union libre', 'Divorc√©(e)', 'Veuf(ve)'];
    const FUNCTIONS = ['Caissier', 'Analyste', 'M√©canicien', 'Cuisinier', 'Femme de m√©nage', 'Manager logistique', 'Directeur de terrain', 'Charg√© RH', 'Assistant m√©dical', 'Technicien WASH'];
    const PAYMENT_METHODS = ['Virement', 'Cash', 'Mobile'];
    const LEAVE_TYPES = ['Cong√©s pay√©s', 'Arr√™t maladie', 'Cong√©s maternit√©', 'Cong√©s sans solde'];
    const FIRSTNAMES = ['A√Øcha','Marc','Sofia','Luca','Fatoumata','Jonas','Nadia','Paul','Th√©o','Emma','Noah','L√©a','Lucas','Mila','Ethan','Camille','Hugo','Zo√©','Chlo√©','L√©na'];
    const LASTNAMES = ['Diallo','Nguyen','Ben Youssef','Rossi','Traor√©','Meier','Martin','Bernard','Dubois','Moreau','Petit','Robert','Richard','Durand','Leroy','Roux'];
    const STREETS = ['avenue du Fleuve','rue de la Paix','boulevard Lumumba','quartier Botanique','cit√© des Artisans','route des Manguiers'];
    const DIPLOMAS = ['Licence en gestion', 'BTS informatique', 'Master en logistique', 'Licence en finance', 'Master en ressources humaines', 'CAP m√©canique'];
    const EDUCATION_LEVELS = ['Bac +2', 'Bac +3', 'Master', 'Doctorat', 'CAP'];
    const DOMAINS = ['comptabilit√©', 'gestion de projet', 'maintenance industrielle', 'administration', 'logistique', 'finance', 'RH op√©rationnel'];
    const LANGUAGE_LEVELS = ['A2','B1','B2','C1','C2'];

    const PERIODS = ['2025-01','2025-02','2025-03','2025-04'];

    const state = {
      employees: [],
      selectionId: null
    };

    const terrainSelect = document.getElementById('terrainSelect');
    const listEl = document.getElementById('list');
    const listCount = document.getElementById('listCount');
    const contextPill = document.getElementById('contextPill');
    const detailEl = document.getElementById('detail');
    const statsEl = document.getElementById('stats');
    const searchInput = document.getElementById('globalSearch');
    const contractFilter = document.getElementById('contractFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');

    const monthFormatter = new Intl.DateTimeFormat('fr-FR',{ month:'long', year:'numeric' });

    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function pick(arr){ return arr[rand(0, arr.length-1)]; }
    function uid(prefix='id'){ return `${prefix}-${Math.random().toString(36).slice(2,8)}`; }

    function formatDate(dateStr){
      const d = new Date(dateStr);
      if(Number.isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleDateString('fr-FR');
    }

    function formatMonth(period){
      const d = new Date(period + '-01');
      return monthFormatter.format(d);
    }

    function calculateAge(birthDate){
      const d = new Date(birthDate);
      if(Number.isNaN(d.getTime())) return '‚Äî';
      const diff = Date.now() - d.getTime();
      const ageDate = new Date(diff);
      return Math.abs(ageDate.getUTCFullYear() - 1970);
    }

    function buildContractHistory(terrain, role, baseSalary, contractType, socioCategory, echelon, level){
      const history = [];
      const entries = rand(2,3);
      let currentStartYear = rand(2021,2023);
      let currentStartMonth = rand(1,9);
      for(let i=0;i<entries;i++){
        const startMonth = String(currentStartMonth).padStart(2,'0');
        const startDay = String(rand(1,28)).padStart(2,'0');
        const startDate = `${currentStartYear}-${startMonth}-${startDay}`;
        let endDate = null;
        if(i < entries-1){
          const durationMonths = rand(10,18);
          const end = new Date(startDate);
          end.setMonth(end.getMonth()+durationMonths);
          endDate = `${end.getFullYear()}-${String(end.getMonth()+1).padStart(2,'0')}-${String(rand(1,28)).padStart(2,'0')}`;
          currentStartYear = end.getFullYear();
          currentStartMonth = end.getMonth()+2;
          if(currentStartMonth>12){
            currentStartYear += 1;
            currentStartMonth -= 12;
          }
        }
        const type = i===0? 'Nouveau contrat' : (i===1? 'Renouvellement' : pick(['Amendement','Renouvellement']));
        const increment = i===0?0:rand(20,120);
        history.push({
          id: uid('contract'),
          label: type,
          contractType,
          startDate,
          endDate,
          functionName: role,
          socioCategory,
          echelon,
          level,
          gridFunction: `GF_${terrain.code}_V1`,
          salaryGrid: `GS_${terrain.code}_V1`,
          baseSalary: baseSalary + increment,
          currency: terrain.currency
        });
      }
      if(history.length){ history[history.length-1].endDate = null; }
      return history;
    }

    function buildDependants(){
      const dependants = [];
      const count = rand(0,4);
      for(let i=0;i<count;i++){
        const relation = pick(['Enfant','Enfant','Enfant','Epoux(se)','Concubin']);
        const name = `${pick(FIRSTNAMES)} ${pick(LASTNAMES)}`;
        const birthYear = relation==='Enfant'? rand(2008,2021) : rand(1978,1995);
        const birthMonth = String(rand(1,12)).padStart(2,'0');
        const birthDay = String(rand(1,28)).padStart(2,'0');
        const dependant = {
          id: uid('dep'),
          name,
          relation,
          birthDate: `${birthYear}-${birthMonth}-${birthDay}`,
          active: Math.random() > 0.1
        };
        if(relation==='Enfant'){
          dependant.childStatus = pick(['√âtudiant','Non √©tudiant']);
          dependant.handicap = Math.random()<0.1;
          dependant.worker = Math.random()<0.3;
        }else{
          dependant.worker = Math.random()<0.6;
        }
        dependants.push(dependant);
      }
      return dependants;
    }

    function buildLeaves(){
      const leaves = [];
      const count = rand(1,3);
      for(let i=0;i<count;i++){
        const type = pick(LEAVE_TYPES);
        const start = new Date(2024, rand(0,9), rand(1,25));
        const duration = rand(3,15);
        const end = new Date(start);
        end.setDate(start.getDate()+duration);
        leaves.push({
          id: uid('leave'),
          type,
          startDate: start.toISOString().split('T')[0],
          endDate: end.toISOString().split('T')[0],
          days: duration,
          counted: Math.random()>0.2
        });
      }
      return leaves;
    }

    function buildQualifications(){
      const educationLevel = pick(EDUCATION_LEVELS);
      const diploma = pick(DIPLOMAS);
      const year = rand(2010,2023);
      const domains = Array.from({length:rand(2,3)},()=>pick(DOMAINS)).filter((v,i,a)=>a.indexOf(v)===i);
      const languages = [
        { name:'Anglais', level: pick(LANGUAGE_LEVELS) },
        { name:'Espagnol', level: pick(LANGUAGE_LEVELS) }
      ];
      return {
        educationLevel,
        diploma,
        year,
        domains,
        languages,
        languageFlags: {
          fr: true,
          es: Math.random()>0.4,
          en: Math.random()>0.3
        }
      };
    }

    function buildBulletins(baseSalary, terrain){
      return PERIODS.map((period, idx)=>{
        const overtime = rand(20,150);
        const seniority = Math.round(baseSalary * 0.06);
        const transport = rand(45,90);
        const leavePay = rand(0,80);
        const social = Math.round(baseSalary * 0.12);
        const employer = Math.round(baseSalary * 0.08);
        const advance = Math.random()>0.7? rand(40,120) : 0;
        const loan = Math.random()>0.8? rand(50,150) : 0;
        const net = Math.round((baseSalary + overtime + seniority + transport + leavePay - social - employer - advance - loan)*100)/100;
        const status = idx < PERIODS.length-1 ? 'Pay√©' : (Math.random()>0.3 ? 'Pay√©' : '√Ä payer');
        const method = pick(PAYMENT_METHODS);
        const lines = [
          { label:'Salaire de base', amount: baseSalary, category:'gain', tone:'positive' },
          { label:"Heures suppl√©mentaires", amount:overtime, category:'gain', tone:'neutral' },
          { label:"Primes d'anciennet√©", amount:seniority, category:'gain', tone:'positive' },
          { label:'Prime de transport', amount:transport, category:'gain', tone:'positive' },
          { label:'Cong√©s pay√©s', amount:leavePay, category:'gain', tone:'neutral' },
          { label:'Cotisations sociales salariales', amount:social, category:'deduction', tone:'negative' },
          { label:'Cotisations patronales', amount:employer, category:'deduction', tone:'warning' },
          { label:'Acomptes', amount:advance, category:'deduction', tone:'negative' },
          { label:'Pr√™t', amount:loan, category:'deduction', tone:'negative' },
          { label:'Net √† payer', amount:net, category:'summary', tone:'summary' }
        ];
        return {
          id: uid('pay'),
          period,
          status,
          method,
          currency: terrain.currency,
          netAmount: net,
          lines
        };
      });
    }

    function generateEmployees(){
      const employees = [];
      for(let i=0;i<60;i++){
        const civility = pick(CIVILITIES);
        const firstName = pick(FIRSTNAMES);
        const lastName = pick(LASTNAMES);
        const name = `${firstName} ${lastName}`;
        const terrain = pick(TERRAINS);
        const contractType = pick(CONTRACT_TYPES);
        const socioCategory = pick(SOCIO_CATEGORIES);
        const echelon = pick(['A','B','C','D','E','F']);
        const level = pick(['1','2','3','4','5','6','7']);
        const role = pick(FUNCTIONS);
        const baseSalary = rand(700,1900);
        const birthYear = rand(1979,1996);
        const birthMonth = String(rand(1,12)).padStart(2,'0');
        const birthDay = String(rand(1,28)).padStart(2,'0');
        const employee = {
          id: `EMP${String(i+1).padStart(3,'0')}`,
          civility,
          name,
          role,
          contractType,
          socioCategory,
          echelon,
          level,
          status: Math.random()>0.15? 'Actif' : 'Inactif',
          terrain,
          email: `${firstName.toLowerCase().normalize('NFD').replace(/[^a-z]/g,'')}.${lastName.toLowerCase().normalize('NFD').replace(/[^a-z]/g,'')}@homere-connect.demo`,
          phone: `+243 ${rand(80,99)}${rand(1000000,9999999)}`,
          address: `${rand(10,180)} ${pick(STREETS)}`,
          birthDate: `${birthYear}-${birthMonth}-${birthDay}`,
          maritalStatus: pick(MARITAL_STATUS),
          dependants: [],
          leaves: [],
          qualifications: {},
          contractHistory: [],
          bulletins: [],
          baseSalary
        };
        employee.dependants = buildDependants();
        employee.leaves = buildLeaves();
        employee.qualifications = buildQualifications();
        employee.contractHistory = buildContractHistory(terrain, role, baseSalary, contractType, socioCategory, echelon, level);
        employee.currentContract = employee.contractHistory[employee.contractHistory.length-1];
        employee.bulletins = buildBulletins(employee.currentContract.baseSalary, terrain);
        employees.push(employee);
      }
      return employees;
    }

    function populateSelectors(){
      TERRAINS.forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t.code;
        opt.textContent = `${t.code} ¬∑ ${t.name}`;
        terrainSelect.appendChild(opt);
      });
      contractFilter.innerHTML = '<option value="">Tous les contrats</option>' + CONTRACT_TYPES.map(t=>`<option value="${t}">${t}</option>`).join('');
      categoryFilter.innerHTML = '<option value="">Toutes cat√©gories</option>' + SOCIO_CATEGORIES.map(t=>`<option value="${t}">${t}</option>`).join('');
      statusFilter.innerHTML = '<option value="">Tous statuts</option><option value="Actif">Actif</option><option value="Inactif">Inactif</option>';
    }

    function getSelectedTerrain(){
      const code = terrainSelect.value;
      return TERRAINS.find(t=>t.code===code) || TERRAINS[0];
    }

    function getFilteredEmployees(){
      const terrain = getSelectedTerrain();
      const query = searchInput.value.trim().toLowerCase();
      const contractValue = contractFilter.value;
      const categoryValue = categoryFilter.value;
      const statusValue = statusFilter.value;
      return state.employees
        .filter(e=>e.terrain.code===terrain.code)
        .filter(e=> !query || e.name.toLowerCase().includes(query) || e.role.toLowerCase().includes(query) || e.contractType.toLowerCase().includes(query))
        .filter(e=> !contractValue || e.contractType===contractValue)
        .filter(e=> !categoryValue || e.socioCategory===categoryValue)
        .filter(e=> !statusValue || e.status===statusValue);
    }

    function updateStats(count){
      const terrain = getSelectedTerrain();
      statsEl.textContent = `${count} employ√©(s) sur ${terrain.code} ¬∑ ${terrain.name}`;
    }

    function renderList(){
      const rows = getFilteredEmployees();
      if(rows.length===0){
        listEl.innerHTML = '<div class="meta" style="padding:16px">Aucun employ√© ne correspond aux filtres.</div>';
        listCount.textContent = '0';
        contextPill.textContent = `Mode fiche employ√© ‚Ä¢ ${getSelectedTerrain().code}`;
        updateStats(0);
        state.selectionId = null;
        detailEl.innerHTML = '<h2>Filtre actif</h2><p>Aucun r√©sultat. Ajustez les filtres pour afficher des fiches.</p>';
        return;
      }
      listEl.innerHTML = rows.map(e=>{
        const statusBadge = `<span class="badge ${e.status==='Actif'?'ok':'ko'}">${e.status==='Actif'?'OK':'KO'}</span>`;
        return `
          <div class="row" data-id="${e.id}">
            <div class="avatar">üßë‚Äçüíº</div>
            <div>
              <div class="title">${e.name}</div>
              <div class="meta">${e.role} ‚Ä¢ ${e.contractType} ‚Ä¢ ${e.terrain.code}</div>
            </div>
            <div>${statusBadge}</div>
          </div>
        `;
      }).join('');
      listCount.textContent = rows.length;
      contextPill.textContent = `Mode fiche employ√© ‚Ä¢ ${getSelectedTerrain().code}`;
      listEl.querySelectorAll('.row').forEach(row=>{
        row.addEventListener('click',()=>{
          state.selectionId = row.dataset.id;
          renderEmployeeDetail(state.selectionId);
        });
      });
      updateStats(rows.length);
      if(state.selectionId){
        const exists = rows.some(e=>e.id===state.selectionId);
        if(!exists){
          state.selectionId = null;
          detailEl.innerHTML = '<h2>Bienvenue üëã</h2><p>S√©lectionnez un employ√© dans la liste de gauche pour afficher sa fiche d√©taill√©e.</p>';
        }
      }
    }

    function renderBoolean(value){
      return value ? '<span class="indicator yes">‚úÖ Oui</span>' : '<span class="indicator no">‚ùå Non</span>';
    }

    function renderEmployeeDetail(id){
      const employee = state.employees.find(e=>e.id===id);
      if(!employee){
        detailEl.innerHTML = '<h2>Bienvenue üëã</h2><p>S√©lectionnez un employ√© dans la liste de gauche pour afficher sa fiche d√©taill√©e.</p>';
        return;
      }
      const age = calculateAge(employee.birthDate);
      const dependantsCount = employee.dependants.length;
      detailEl.innerHTML = `
        <h2>üßë‚Äçüíº ${employee.name}</h2>
        <div class="grid-3">
          <div class="section kv"><label>Fonction</label><div>${employee.role}</div></div>
          <div class="section kv"><label>Terrain</label><div>${employee.terrain.code} ¬∑ ${employee.terrain.name}</div></div>
          <div class="section kv"><label>Statut</label><div>${employee.status}</div></div>
        </div>
        <div class="grid-3">
          <div class="section kv"><label>Type de contrat</label><div>${employee.contractType}</div></div>
          <div class="section kv"><label>Cat√©gorie socio-prof.</label><div>${employee.socioCategory}</div></div>
          <div class="section kv"><label>D√©pendants</label><div data-role="dependantsCount">${dependantsCount}</div></div>
        </div>

        <div class="section">
          <h3>Informations personnelles</h3>
          <div class="grid-3">
            <div class="kv"><label>Civilit√©</label><div>${employee.civility}</div></div>
            <div class="kv"><label>Date de naissance</label><div>${formatDate(employee.birthDate)}</div></div>
            <div class="kv"><label>√Çge</label><div>${age} ans</div></div>
          </div>
          <div class="grid-3" style="margin-top:12px">
            <div class="kv"><label>Adresse</label><div>${employee.address}</div></div>
            <div class="kv"><label>Email</label><div>${employee.email}</div></div>
            <div class="kv"><label>T√©l√©phone</label><div>${employee.phone}</div></div>
          </div>
          <div class="grid-3" style="margin-top:12px">
            <div class="kv"><label>Statut marital</label><div>${employee.maritalStatus}</div></div>
            <div class="kv"><label>Echelon</label><div>${employee.echelon}</div></div>
            <div class="kv"><label>Niveau</label><div>${employee.level}</div></div>
          </div>
        </div>

        <div class="section">
          <h3>Historique des contrats</h3>
          ${employee.contractHistory.map((c,idx,arr)=>{
            const isOpen = idx===arr.length-1;
            return `
              <div class="accordion">
                <button class="accordion-toggle ${isOpen?'open':''}" data-target="contract-${c.id}">
                  <div class="title-row">
                    <div class="left">
                      <span class="label">${c.label}</span>
                      <span class="chip">${c.contractType}</span>
                    </div>
                    <div class="meta">${formatDate(c.startDate)} ‚Üí ${c.endDate?formatDate(c.endDate):'En cours'}</div>
                  </div>
                  <div class="meta">${c.functionName} ‚Ä¢ Grille ${c.gridFunction}</div>
                </button>
                <div class="accordion-panel ${isOpen?'open':''}" id="contract-${c.id}">
                  <div class="grid-2">
                    <div class="kv"><label>Type de contrat</label><div>${c.contractType}</div></div>
                    <div class="kv"><label>Fonction</label><div>${c.functionName}</div></div>
                  </div>
                  <div class="grid-2">
                    <div class="kv"><label>Date de d√©but</label><div>${formatDate(c.startDate)}</div></div>
                    <div class="kv"><label>Date de fin</label><div>${c.endDate?formatDate(c.endDate):'‚Äî'}</div></div>
                  </div>
                  <div class="grid-2">
                    <div class="kv"><label>Grille de fonction</label><div>${c.gridFunction}</div></div>
                    <div class="kv"><label>Grille de salaire</label><div>${c.salaryGrid}</div></div>
                  </div>
                  <div class="grid-2">
                    <div class="kv"><label>Cat√©gorie socio-prof.</label><div>${c.socioCategory}</div></div>
                    <div class="kv"><label>Echelon / Niveau</label><div>${c.echelon} ‚Ä¢ ${c.level}</div></div>
                  </div>
                  <div class="kv" style="margin-top:12px"><label>Salaire de base</label><div>${c.currency} ${c.baseSalary.toLocaleString('fr-FR')}</div></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        <div class="section">
          <h3>Personnes √† charge / D√©pendants</h3>
          ${employee.dependants.length ? `
            <table class="table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Date de naissance</th>
                  <th>Lien</th>
                  <th>Statut</th>
                  <th>Handicap</th>
                  <th>Travailleur</th>
                  <th>Actif</th>
                </tr>
              </thead>
              <tbody>
                ${employee.dependants.map(dep=>`
                  <tr>
                    <td>${dep.name}</td>
                    <td>${formatDate(dep.birthDate)}</td>
                    <td>${dep.relation}</td>
                    <td>${dep.relation==='Enfant' ? dep.childStatus : '‚Äî'}</td>
                    <td>${dep.relation==='Enfant' ? renderBoolean(dep.handicap) : '‚Äî'}</td>
                    <td>${renderBoolean(dep.worker)}</td>
                    <td>${dep.active ? '<span class="indicator yes">‚úÖ</span>' : '<span class="indicator no">‚ùå</span>'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          ` : '<div class="meta">Aucun d√©pendant enregistr√©.</div>'}
        </div>

        <div class="section">
          <h3>Cong√©s</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Date de d√©but</th>
                <th>Date de fin</th>
                <th>Nombre de jours</th>
                <th>Comptabilis√© bulletin</th>
              </tr>
            </thead>
            <tbody>
              ${employee.leaves.map(leave=>`
                <tr>
                  <td>${leave.type}</td>
                  <td>${formatDate(leave.startDate)}</td>
                  <td>${formatDate(leave.endDate)}</td>
                  <td>${leave.days}</td>
                  <td>${leave.counted ? '<span class="indicator yes">‚úÖ</span>' : '<span class="indicator no">‚ùå</span>'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="section">
          <h3>Qualifications</h3>
          <div class="grid-3">
            <div class="kv"><label>Niveau d\u2019√©tudes</label><div>${employee.qualifications.educationLevel}</div></div>
            <div class="kv"><label>Dernier dipl√¥me</label><div>${employee.qualifications.diploma}</div></div>
            <div class="kv"><label>Ann√©e d\u2019obtention</label><div>${employee.qualifications.year}</div></div>
          </div>
          <div class="kv" style="margin-top:12px"><label>Domaines de comp√©tence</label><div>${employee.qualifications.domains.join(', ')}</div></div>
          <div class="kv" style="margin-top:12px"><label>Comp√©tences linguistiques</label><div>${employee.qualifications.languages.map(l=>`${l.name} ${l.level}`).join(' ‚Ä¢ ')}</div></div>
          <div class="grid-3" style="margin-top:12px">
            <div class="kv"><label>Fran√ßais</label><div>${employee.qualifications.languageFlags.fr ? 'üá´üá∑ Oui' : 'üá´üá∑ Non'}</div></div>
            <div class="kv"><label>Espagnol</label><div>${employee.qualifications.languageFlags.es ? 'üá™üá∏ Oui' : 'üá™üá∏ Non'}</div></div>
            <div class="kv"><label>Anglais</label><div>${employee.qualifications.languageFlags.en ? 'üá¨üáß Oui' : 'üá¨üáß Non'}</div></div>
          </div>
        </div>

        <div class="section">
          <h3>Bulletins de salaire</h3>
          ${employee.bulletins.map((b,idx)=>{
            const isOpen = idx===employee.bulletins.length-1;
            return `
              <div class="accordion">
                <button class="accordion-toggle ${isOpen?'open':''}" data-target="bulletin-${b.id}">
                  <div class="title-row">
                    <div class="left">
                      <span class="label">${formatMonth(b.period)}</span>
                      <span class="chip">${b.status}</span>
                    </div>
                    <div class="meta">${b.currency} ${b.netAmount.toLocaleString('fr-FR')} ‚Ä¢ ${b.method} ‚Ä¢ <span class="download-icon">üìÑ</span></div>
                  </div>
                </button>
                <div class="accordion-panel ${isOpen?'open':''}" id="bulletin-${b.id}">
                  <table class="payroll-lines">
                    <tbody>
                      ${b.lines.map(line=>`
                        <tr class="${line.tone} ${line.category}">
                          <td>${line.label}</td>
                          <td style="text-align:right">${line.category==='deduction' ? '‚àí ' : ''}${b.currency} ${line.amount.toLocaleString('fr-FR')}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      detailEl.querySelectorAll('.accordion-toggle').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const target = detailEl.querySelector(`#${btn.dataset.target}`);
          const isOpen = target.classList.toggle('open');
          btn.classList.toggle('open', isOpen);
        });
      });

      const dependantsCountEl = detailEl.querySelector('[data-role="dependantsCount"]');
      if(dependantsCountEl){ dependantsCountEl.textContent = employee.dependants.length; }
    }

    function init(){
      populateSelectors();
      terrainSelect.value = TERRAINS[0].code;
      state.employees = generateEmployees();
      renderList();
      terrainSelect.addEventListener('change',()=>{
        renderList();
        detailEl.innerHTML = '<h2>Bienvenue üëã</h2><p>S√©lectionnez un employ√© dans la liste de gauche pour afficher sa fiche d√©taill√©e.</p>';
        state.selectionId=null;
      });
      searchInput.addEventListener('input',()=>{ renderList(); });
      [contractFilter, categoryFilter, statusFilter].forEach(select=>{
        select.addEventListener('change',()=>{ renderList(); });
      });
    }

    init();
  </script>
</body>
</html>
